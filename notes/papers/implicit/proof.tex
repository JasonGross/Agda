
Our goal is to prove that we only compute with well-typed terms, in the sense
of {\Core}. This guarantees the existence of normal forms, and hence, ensure
decidability of type checking.

The proof will be done in two stages: first we prove soundness in the absence
of constraint simplification, and then we prove that constraint simplification
is sound.

\subsection{Without constraint solving}

There are a number of things we need to prove: that type checking preserves
well-formed signatures, that it produces well-typed terms, that conversion
checking is sound, and that new signatures respect the old signatures.
Unfortunately these properties are all interdependent, so we cannot prove them
separately. Instead we prove them all in one fell swoop. First we define what
we mean by a signature extension.

\begin{definition}[Signature extension] \label{defSigExt}
    We say that $\Sigma'$ {\em extends} $\Sigma$ if and only if for any {\Core}
    derivation in $\Sigma$ there is an equivalent derivation in $\Sigma'$.
\end{definition}

Note that this definition admits both simple extensions--adding a new
constant--and refinement, where we give a definition to a constant. This is
expressed by the following two lemmas.

\begin{lemma}[Signature weakening] \label{lemWeakenSig}
    If $\Sigma' = \Ext \Sigma {c:A}$ and $\IsSigCS {\Sigma'}$ then $\Extends
    {\Sigma'} \Sigma$.
\end{lemma}

\begin{lemma}[Signature refinement] \label{lemRefineSig}
    Giving a definition to a constant in a signature is an extension of the
    signature. More precisely, if
    \begin{itemize}
	\item $\HasTypeCS {\Sigma_1} {} M A$
	\item $\Sigma ~ = ~ \Ext {\Sigma_1} \Ext {\MetaDecl c A} \Sigma_2$
	\item $\Sigma' ~ = ~ \Ext {\Sigma_1} \Ext {\IMetaDecl c A M} \Sigma_2$
    \end{itemize}
    then $\Extends {\Sigma'} \Sigma$.
\end{lemma}

\begin{proof}[Proofs]
    In both lemmas any derivation using $\Sigma$ is immediately valid also with $\Sigma'$.
\end{proof}

To express the soundness of conversion checking we need to define when a
constraint is well-formed.

\begin{definition}[Well-formed constraint]
    The rules for well-formed constraints are
    \[
	\infer{ \ValidConstr \Sigma {\TypeConstr A B}}
	{\begin{array}{l}
	    \IsTypeCS \Sigma \Gamma A \\
	    \IsTypeCS \Sigma \Gamma B 
	\end{array}}
    \qquad
	\infer{ \ValidConstr \Sigma {\TermConstr M N A}}
	{\begin{array}{l}
	    \HasTypeCS \Sigma \Gamma M A \\
	    \HasTypeCS \Sigma \Gamma N A \\
	\end{array}}
    \]
\end{definition}

Well-formedness extends in the obvious way to sets of constraints.

\begin{theorem}[Soundness of type checking] \label{thmSoundNoCs}
    Type checking produces well-typed terms, conversion checking produces
    well-formed constraints and if no constraints are produced, the conversion
    is valid in {\Core}. Also, all rules produce well-formed extensions of the
    signature.
    \begin{itemize}

	% is type
	\item
	    $\begin{array}[t]{l}
		\ExplicitJudgement \Sigma {\IsType e A} {\Sigma'}
		~ \wedge ~ \IsCtxCS \Sigma \Gamma \\
		{} \implies \Extends {\Sigma'} {\Sigma}
		~ \wedge ~ \IsTypeCS {\Sigma'} \Gamma A
	    \end{array}$

	% check type
	\item
	    $\begin{array}[t]{l}
		\ExplicitJudgement \Sigma {\CheckType e A M} {\Sigma'}
		~ \wedge ~ \IsTypeCS \Sigma \Gamma A \\
		{} \implies \Extends {\Sigma'} {\Sigma}
		~ \wedge ~ \HasTypeCS {\Sigma'} \Gamma M A
	    \end{array}$

	% infer type
	\item
	    $\begin{array}[t]{l}
		\ExplicitJudgement \Sigma {\InferType e A M} {\Sigma'}
		~ \wedge ~ \IsCtxCS \Sigma \Gamma \\
		{} \implies \Extends {\Sigma'} {\Sigma}
		~ \wedge ~ \HasTypeCS {\Sigma'} \Gamma M A
	    \end{array}$

	% equal types
	\item
	    $\begin{array}[t]{l}
		\ExplicitJudgement \Sigma {\EqualType A B \Cs} {\Sigma'}
		~ \wedge ~ \IsTypeCS \Sigma \Gamma A
		~ \wedge ~ \IsTypeCS \Sigma \Gamma B
		\\
		{} \implies \Extends {\Sigma'} {\Sigma}
		~ \wedge ~ \ValidConstr {\Sigma'} \Cs
		~ \wedge ~ (\Cs = \emptyset \implies \EqualTypeCS {\Sigma'} \Gamma A B)
	    \end{array}$

	% equal terms
	\item
	    $\begin{array}[t]{l}
		\ExplicitJudgement \Sigma {\Equal M N A \Cs} {\Sigma'}
		~ \wedge ~ \HasTypeCS \Sigma \Gamma M A
		~ \wedge ~ \HasTypeCS \Sigma \Gamma N A
		\\
		{} \implies \Extends {\Sigma'} {\Sigma}
		~ \wedge ~ \ValidConstr {\Sigma'} \Cs
		~ \wedge ~ (\Cs = \emptyset \implies \EqualCS {\Sigma'} \Gamma M N A)
	    \end{array}$

    \end{itemize}

    The statements for weak head normal form conversion ($\EqualWhnf M N A
    \Cs$) and term sequence conversion ($\Equal {\bar M} {\bar N} \Delta \Cs$)
    are equivalent to that of term conversion.
\end{theorem}

\begin{proof}
    By induction on the derivation. Some interesting cases:
    \begin{itemize}

	\item {\em (TODO: Not so interesting)} In the type conversion case for
	function spaces where the domains produce constraints, we have to use
	Lemma~\ref{lemCoreSubstType}.

	\item In the term conversion case where the terms are weak head
	normalised we need subject reduction for weak head normalisation
	(Lemma~\ref{lemCoreSubjectReduction}).

	\item When checking conversion of terms with the same head we need an
	inversion principle for application (Lemma~\ref{lemCoreAppInv}).

	\item The most interesting case is the meta variable instantiation
	case, so let us spell that out in more detail.

	The instantiation rule does not produce any constraints, so the only
	thing we have to prove is that it constructs a valid extension of the
	signature. This follows from the signature refinement lemma
	(Lemma~\ref{lemRefineSig}) which can be applied if we prove that if
	$\Sigma = \Ext {\Sigma_1} \Ext {\MetaDecl \alpha {B'}} \Sigma_2$ then
	$\LAM {\bar x} M : {B'}$.

	We have $\HasTypeCS \Sigma \Gamma {\alpha \, \bar x} A$ so $B'$ must
	have the form $\PI {\bar x} \Delta B$. By Lemma~\ref{lemCoreAppInv} we
	conclude that $\HasTypeCS \Sigma \Gamma {\bar x} \Delta$ and thus
	$\HasTypeCS \Sigma \Gamma {\alpha \, \bar x} B$. Then by
	Lemma~\ref{lemCoreEqType} $\EqualTypeCS \Sigma \Gamma A B$.

	From $\HasTypeCS \Sigma \Gamma M A$ we get $\HasTypeCS \Sigma \Gamma M
	B$ and using Lemma~\ref{lemCoreShadow}  $\HasTypeCS \Sigma \Gamma {\LAM
	{\bar x} M} {\Delta \to B}$. We know that $\Delta \to B$ is a closed
	type, and since $\FV{M} \subseteq \bar x$, $\LAM {\bar x} M$ is also
	closed. Thus by strenghtening (Lemma~\ref{lemCoreStrengthen})
	$\HasTypeCS \Sigma {} {\LAM {\bar x} M} {\Delta \to B}$. We have
	$\IsTypeCS {\Sigma_1} {} {\Delta \to B}$ and $\InScope \alpha M$ so
	$\HasTypeCS {\Sigma_1} {} {\LAM {\bar x} M} {\Delta \to B}$ which is
	what we set out to prove.

	\TODO{The $\InScope \alpha M$ reasoning is a bit shaky. What exactly
	does it mean that $M$ is in scope?}

    \end{itemize}
\end{proof}

Since well-typed terms in {\Core} have weak head normal forms we get the
existence of weak head normal forms for type checked terms.

\begin{corollary}
    Type checked terms have weak head normal forms.
\end{corollary}

Once we have weak head normal forms it is easy to verify that the rules
describe a decidable type checking algorithm.

\begin{corollary}
    Type checking is decidable.
\end{corollary}

\subsection{Constraint solving}

This far we have completely ignored the generated constraints--when conversion
checking produced constraints we only required them to be well-formed. In this
section we tackle the problem of ensuring that solving the constraints produce
well-typed terms. The idea is to prove that constraint simplification is a
signature extension operation in the sense of Definition~\ref{defSigExt}. To
prove this we need to know that type checking preserves {\em consistent}
signatures.

\begin{definition}[Ensures] \label{defEnsures}
    A set of constraints $\Cs$ {\em ensures} a judgement $J$ in a signature
    $\Sigma$ if, for any $\Sigma_1$ such that
    \begin{itemize}
	\item $\Extends {\Sigma_1} \Sigma$
	\item $\ExplicitJudgement {\Sigma_1} {\CheckConstr \Cs \emptyset} {\Sigma_2}$
    \end{itemize}
    it is the case that $\vdash_{\Sigma_2} J$.
\end{definition}

\begin{lemma} \label{lemExtendEnsures}
    If $\Cs$ ensures $J$ in $\Sigma$ and $\Extends {\Sigma'} \Sigma$ then $\Cs$
    ensures $J$ in $\Sigma'$.
\end{lemma}

\begin{definition}[Consistent signature] \label{defConsistentSig}
    A signature $\Sigma$ is said to be {\em consistent} if $\Sigma = \Ext
    {\Sigma_1} \Ext {\ConstDecl p A M \Cs} \Sigma_2$ implies that $\Cs$ ensures
    $\HasTypeC {} M A$ in $\Sigma_1$.
\end{definition}

In order to prove that type checking preserves consistency, we first need to
know that the constraints we produce are sound.

\begin{lemma}[Soundness of generated constraints] \label{lemSoundConstraints}
    The constraints generated during conversion checking ensures that the
    checked terms are convertible.
    More precisely,
    \begin{itemize}
	\item \( \begin{array}[t]{l}
		    \IsTypeCS \Sigma \Gamma A
		    ~ \wedge ~ \IsTypeCS \Sigma \Gamma B
		    ~ \wedge ~ \ExplicitJudgement \Sigma {\EqualType A B \Cs} {\Sigma'}
		    \\ {} \implies \mbox{$\Cs$ ensures $\EqualTypeC \Gamma A B$ in $\Sigma'$}
	      \end{array} \)
	\item \( \begin{array}[t]{l}
		    \HasTypeCS \Sigma \Gamma M A
		    ~ \wedge ~ \HasTypeCS \Sigma \Gamma N A
		    ~ \wedge ~ \ExplicitJudgement \Sigma {\Equal M N A \Cs} {\Sigma'}
		    \\ {} \implies \mbox{$\Cs$ ensures $\EqualC \Gamma M N A$ in $\Sigma'$}
	      \end{array} \)
    \end{itemize}
\end{lemma}

\begin{proof}
    Again we highlight some interesting cases.
    \begin{itemize}
	\item 
	
	The only difficult case is the case of conversion for function types
	where a new constant $p$ is introduced. There we need to prove
	$\EqualTypeCS {\Sigma_2} {\Ext \Gamma x : A_1} {B_1} {B_2}$ from
	$\EqualTypeCS {\Sigma_2} {\Ext \Gamma x : A_1} {B_1} {\SubstD {B_2} {p
	\, \Gamma \, x}}$

	If $\Sigma_2$ has an empty guard for $p$ then $p \, \Gamma \, x$
	reduces to $x$ and we are done. If the guard is non-empty we can apply
	Lemma~\ref{lemCoreEqualDummySubst}, since $p \, \Gamma \, x$ is on weak
	head normal form, and $p$ is a fresh constant which does not appear in
	$B_1$.

	\item In the case where $\Cs$ is known (for instance, in the rule for
	blocked terms), we can apply soundness of conversion checking
	(Theorem~\ref{thmSoundNoCs}) to get $\TrueConstr {\Sigma_2} \Cs$.

    \end{itemize}
\end{proof}

\begin{lemma}[Refinement preserves consistency] \label{lemRefineConsistent}
    If
    \begin{itemize}
	\item $\HasTypeCS {\Sigma_1} {} M A$
	\item $\Sigma ~ = ~ \Ext {\Sigma_1} \Ext {\MetaDecl c A} \Sigma_2$
	\item $\Sigma' ~ = ~ \Ext {\Sigma_1} \Ext {\IMetaDecl c A M} \Sigma_2$
	\item $\Sigma$ is consistent
    \end{itemize}
    then $\Sigma'$ is consistent.
\end{lemma}

\begin{proof}
    There are two cases to consider: refinement to the left and to the right of
    a guard. In the latter case the proof is trivial, and in the former case
    consistency follows from the fact that refinement extends a signature
    (Lemma~\ref{lemRefineSig}).
\end{proof}

\begin{lemma}[Type checking preserves consistency] \label{lemTypeCheckConsistent}
Type checking and conversion checking preserves consistent signatures. More precisely,
    \begin{itemize}

	% is type
	\item
	    $\begin{array}[t]{l}
		\ExplicitJudgement \Sigma {\IsType e A} {\Sigma'}
		~ \wedge ~ \IsCtxCS \Sigma \Gamma
		~ \wedge ~ \mbox{$\Sigma$ is consistent}
		\\ {} \implies \mbox{$\Sigma'$ is consistent}
	    \end{array}$

	% check type
	\item
	    $\begin{array}[t]{l}
		\ExplicitJudgement \Sigma {\CheckType e A M} {\Sigma'}
		~ \wedge ~ \IsTypeCS \Sigma \Gamma A
		~ \wedge ~ \mbox{$\Sigma$ is consistent}
		\\ {} \implies \mbox{$\Sigma'$ is consistent}
	    \end{array}$

	% infer type
	\item
	    $\begin{array}[t]{l}
		\ExplicitJudgement \Sigma {\InferType e A M} {\Sigma'}
		~ \wedge ~ \IsCtxCS \Sigma \Gamma
		~ \wedge ~ \mbox{$\Sigma$ is consistent}
		\\ {} \implies \mbox{$\Sigma'$ is consistent}
	    \end{array}$

	% equal types
	\item
	    $\begin{array}[t]{l}
		\ExplicitJudgement \Sigma {\EqualType A B \Cs} {\Sigma'}
		~ \wedge ~ \IsTypeCS \Sigma \Gamma A
		~ \wedge ~ \IsTypeCS \Sigma \Gamma B \\
		~ \wedge ~ \mbox{$\Sigma$ is consistent}
		\\ {} \implies \mbox{$\Sigma'$ is consistent}
	    \end{array}$

	% equal terms
	\item
	    $\begin{array}[t]{l}
		\ExplicitJudgement \Sigma {\Equal M N A \Cs} {\Sigma'}
		~ \wedge ~ \HasTypeCS \Sigma \Gamma M A
		~ \wedge ~ \HasTypeCS \Sigma \Gamma N A \\
		~ \wedge ~ \mbox{$\Sigma$ is consistent}
		\\ {} \implies \mbox{$\Sigma'$ is consistent}
	    \end{array}$

    \end{itemize}

    The statements for weak head normal form conversion ($\EqualWhnf M N A
    \Cs$) and term sequence conversion ($\Equal {\bar M} {\bar N} \Delta \Cs$)
    are equivalent to that of term conversion.
\end{lemma}

\begin{proof}
    By induction on the derivation. We only need to consider the cases where
    the signature changes. Adding a (non-guarded) constant trivially preserves
    consistency, instantiating a meta variable preserves consistency by
    Lemma~\ref{lemRefineConsistent}. What remains is to check that new guarded
    constants are consistent. There are two cases: the conversion rule and
    conversion checking of function types. In both cases consistency follows
    from soundness of conversion checking (Lemma~\ref{lemSoundConstraints}).
\end{proof}

\begin{lemma}[Constraint solving is sound] \label{lemSolveConsistent}
    If $\Sigma$ is consistent and $\ExplicitJudgement \Sigma \Simplify
    {\Sigma'}$ then $\Sigma'$ is consistent and $\Extends {\Sigma'} \Sigma$.
\end{lemma}

\begin{proof}
    Follows from Theorem~\ref{thmSoundNoCs}, Lemma~\ref{lemSoundConstraints},
    and Lemma~\ref{lemTypeCheckConsistent}.
\end{proof}

From this follows that we can mix type checking and constraint solving freely,
so we add the rules

\[  \infer{ J }
    { \Simplify
    & J
    }
    \qquad
    \infer{ J }
    { J
    & \Simplify
    }
\]
to the type checking algorithm.

\begin{theorem}[Soundness of type checking] \label{thmMain}
    If $\Sigma$ is a well-formed signature not containg any meta variables or
    guarded constants and $\ExplicitJudgement \Sigma {\CheckType e A M}
    {\Sigma'}$, then $\Sigma' = \Ext \Sigma {\Sigma''}$. Furthermore, if all
    meta variables have been instantiated and all guards are empty in
    $\Sigma''$, then $\HasTypeCS \Sigma \Gamma {M\sigma} A$ where $\sigma$ is
    the substitution inlining the meta variables and constants in $\Sigma''$.
\end{theorem}

\TODO{A bit clunky. How to express this more elegantly?}

\begin{proof}
    From Lemma~\ref{lemTypeCheckConsistent} and Lemma~\ref{lemSolveConsistent}
    follows that $\HasTypeCS {\Sigma'} \Gamma M A$ and $\Sigma'$ is a
    consistent extension of $\Sigma$.  Thus all definitions in $\Sigma''$ are
    type correct, and consequently so is $\sigma$.  This gives $\HasTypeCS
    {\Sigma'} \Gamma {M\sigma} A$.  Since all constants in $\Sigma''$ have
    a definition $M\sigma$ does not use anything from $\Sigma''$ and we can
    strengthen the signature to obtain $\HasTypeCS \Sigma \Gamma {M\sigma} A$.
\end{proof}

