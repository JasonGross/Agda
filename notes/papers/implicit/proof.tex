
Our goal is to prove that we only compute with well-typed terms, in the sense
of {\Core}. This guarantees the existence of normal forms, and hence, ensure
decidability of type checking.

The proof will be done in two stages: first we prove soundness in the absence
of constraint simplification, and then we prove that constraint simplification
is sound.

\subsection{Without constraint solving}

\begin{lemma}[Well-formed signatures] \label{lemValidSig}
    Type checking preserves well-formed signatures. More precisely, for $J$
    ranging over the type checking and convertibility checking judgements we
    have
    \[{\ExplicitJudgement \Sigma J {\Sigma'}} \, \mathrel{\wedge} \,
	{\IsSigCS \Sigma}  ~ \implies ~ \IsSigCS {\Sigma'}
    \]
\end{lemma}
\begin{proof}
    By induction on the derivation of $\ExplicitJudgement \Sigma J {\Sigma'}$.
    We only have to check the cases where we change the signature, i.e. when we
    add a meta variable or guarded constant or when we instantiate a meta
    variable. In the case where we add a constant with a non-empty guard we can
    ignore the body, since it is not visible in {\Core}. The only interesting
    case is the meta variable instantiation case.
\end{proof}

\begin{definition}[Signature extension]
    We say that $\Sigma'$ {\em extends} $\Sigma$ if and only if
    \[\begin{array}{lcl}
	\IsTypeCS \Sigma \Gamma A & \implies & \IsTypeCS {\Sigma'} \Gamma A \\
	\HasTypeCS \Sigma \Gamma M A & \implies & \HasTypeCS {\Sigma'} \Gamma M A
    \end{array}\]
\end{definition}

\begin{lemma} \label{lemExtendSig}
    If $\ExplicitJudgement \Sigma J {\Sigma'}$ then $\Sigma'$ extends $\Sigma$.
\end{lemma}

In order to guarantee type safety we need soundness of convertibility checking.

\begin{lemma}[Soundness of term convertibility checking, no constraints] \label{lemConvSound}
    If convertibility checking of two terms does not produce any constraints, then
    they are convertible in {\Core}. More precisely if $\IsTypeCS \Sigma \Gamma A$,
    $\IsTypeCS \Sigma \Gamma B$, $\HasTypeCS \Sigma \Gamma M A$, and
    $\HasTypeCS \Sigma \Gamma N A$, then
    \[\begin{array}{lcl}
	\ExplicitJudgement \Sigma {\EqualType A B \emptyset} {\Sigma'}
	    & \implies & \EqualTypeCS {\Sigma'} \Gamma A B \\
	\ExplicitJudgement \Sigma {\Equal M N A \emptyset} {\Sigma'}
	    & \implies & \EqualCS {\Sigma'} \Gamma M N A \\
    \end{array}\]
\end{lemma}

\begin{proof}
    By induction on the derivation using the fact that weak head normalisation
    preserves convertibility in {\Core}. The only case where something
    interesting happens is the meta variable instantiation case where we have
    to prove $\EqualCS {\Sigma'} \Gamma {\alpha\,\bar x} M A$, where $\Sigma'$
    defines $\alpha = \LAM {\bar x} M$. By Lemma ~ \ref{lemValidSig} we know
    that $\Sigma'$ is well-formed, and so the proof is by unfolding $\alpha$
    and performing $\beta$-reducing the result.
\end{proof}

\begin{theorem}[Type-safety] \label{thmTypeSafety}
    Terms produced by type checking are type correct in {\Core} regardless of any
    constraints.

    \[\begin{array}{lcl}
	{\ExplicitJudgement \Sigma {\IsType e A} {\Sigma'}}
	& \implies & {\IsTypeCS {\CoreSig{\Sigma'}} \Gamma A} \\
	{\ExplicitJudgement \Sigma {\CheckType e A M} {\Sigma'}}
	\, \wedge \, {\IsTypeCS {\CoreSig \Sigma} \Gamma A}
	& \implies & \HasTypeCS {\CoreSig{\Sigma'}} \Gamma M A \\
	{\ExplicitJudgement \Sigma {\InferType e A M} {\Sigma'}}
	& \implies & \HasTypeCS {\CoreSig{\Sigma'}} \Gamma M A
    \end{array}\]
\end{theorem}

\begin{proof}
    The proof is straighforward by induction on the typing derivation. In the
    case of the conversion rule, if the types are convertible without producing
    any constraints we rely on the soundness of the convertibility checker
    (Lemma ~ \ref{lemConvSound}). If there are constraints the resulting term
    is a fresh constant that is well-typed by definition.
\end{proof}

Since well-typed terms in {\Core} have weak head normal forms we get the
existence of weak head normal forms for type checked terms.

\begin{corollary}
    Type checked terms have weak head normal forms.
\end{corollary}

Once we have weak head normal forms it is easy to verify that the rules
describe a decidable type checking algorithm.

\begin{corollary}
    Type checking is decidable.
\end{corollary}

\subsection{Constraint solving}

% \begin{lemma}[Soundness of term convertibility checking] \label{thmConvSound}
%     If two terms are checked convertible relative to a set of constraints, then
%     any solution to these constraints makes the terms convertible in {\Core}.
%     More precisely, if
%     \begin{itemize}
% 	\item \( \HasTypeCS \Sigma \Gamma M A ~ \wedge ~
% 		 \HasTypeCS \Sigma \Gamma N A
% 	      \)
% 	\item $\ExplicitJudgement \Sigma {\Equal M N A \Cs} {\Sigma'}$
% 	\item $ \Extends {\Sigma_1} {\Sigma'}$
% 	\item $\ExplicitJudgement
% 		{\Sigma_1}
% 		{\CheckConstr \Cs \emptyset}
% 		{\Sigma_2}
% 	      $
%     \end{itemize}
%     then \( \EqualCS {\Sigma_2} \Gamma M N A \)
% \end{lemma}
% 
% \begin{proof}
%     The interesting case is meta variable instantiation.
% \end{proof}
% 
% The soundness of type convertibility checking is expressed in the same way.
% 
% \begin{lemma}[Soundness of type convertibility checking]
%     If
%     \begin{itemize}
% 	\item \( \IsTypeCS \Sigma \Gamma A ~ \wedge ~
% 		 \IsTypeCS \Sigma \Gamma B
% 	      \)
% 	\item $\ExplicitJudgement \Sigma {\EqualType A B \Cs} {\Sigma'}$
% 	\item $ \Extends {\Sigma_1} {\Sigma'}$
% 	\item $\ExplicitJudgement
% 		{\Sigma_1}
% 		{\CheckConstr \Cs \emptyset}
% 		{\Sigma_2}
% 	      $
%     \end{itemize}
%     then \( \EqualTypeCS {\Sigma_2} \Gamma A B \)
% \end{lemma}
% 
% \begin{corollary} \label{corConvSound}
%     If $\ExplicitJudgement \Sigma {\EqualType A B \emptyset} {\Sigma'}$ then
%     $\EqualTypeCS {\Sigma'} \Gamma A B$.
% \end{corollary}
\begin{theorem}[Soundness]
    If all meta variables are solved and all guards are empty, then we are fine. More precisely, if
    \begin{itemize}
	\item $\ExplicitJudgement \Sigma {\CheckType e A M} {\Sigma'}$
	\item ${\ExplicitJudgement {\Sigma'} \Simplify {\Sigma''}}$
	\item ${\Implements {\Sigma''} {\Sigma}}$ (everything new in $\Sigma''$ has been {\em solved})
	\item ${\ExplicitJudgement {\Sigma''} {\Inline M {\hat M}} {\Sigma''}}$
    \end{itemize}
    then $\HasTypeCS \Sigma \Gamma {\hat M} A$.
\end{theorem}
\begin{proof}
    Follows from Theorem \ref{thmTypeSafety} and Lemma \ref{lemExtendSig} and
    some property of inlining.
\end{proof}

\begin{theorem}[Completeness]
    We are only complete in the sense that if there exists a solution, we find
    an approximation of it.
\end{theorem}
\begin{proof}
    To give the proof we would have to spell out when type checking fails in
    more detail.
\end{proof}

